#!/usr/bin/env -S make -f

m := mobi
to := fella@example.com
rss := https://www.bloomberg.com/opinion/authors/ARbTQlRLRjE/matthew-s-levine.rss
src := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
export mobi_maker := $(shell ebook-convert --version | ruby -pe '$$_=$$_.split(/[)(]/)[1]')

all:
include .download.mk

.download.mk: rss.xml; ruby $(src)/download.rb $(m) < $< > $@
rss.xml:; curl -sfL '$(rss)' > $@

%.send: %.mobi
ifndef catchup
	echo hello | mailx -a $< -- $(to)
endif
	touch $@

%.mobi: %.html; ebook-convert $< $@ --level1-toc //h:h2 > /dev/null
%.html: %.raw; ruby $(src)/raw2html.rb < $< > $@

define help :=
To check for new articles, rm rss.xml

m=$(m)
    modus operandi: create mobi files, with m=send also email them;
    this gets saved in .download.mk until you remove rss.xml

For m=send:

to=$(to)
    your Kindle address
catchup=1
    record sending operations w/o sending anything
endef

help:; $(info $(help))@:

clean:
	find . -type f | grep -E '\.(html|mobi|send)$$' | xargs -r rm
	rm .download.mk

.DELETE_ON_ERROR:
mkdir = @mkdir -p $(dir $@)
